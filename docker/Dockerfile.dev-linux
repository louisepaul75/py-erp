FROM python:3.13-slim

ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

# Install system dependencies
RUN apt-get update \
    && apt-get install -y --no-install-recommends \
        gcc \
        python3-dev \
        libpq-dev \
        postgresql-client \
        netcat-traditional \
        wget \
        curl \
        # WeasyPrint dependencies
        libcairo2 \
        libpango-1.0-0 \
        libpangocairo-1.0-0 \
        libgdk-pixbuf2.0-0 \
        shared-mime-info \
        # Additional tools
        git \
        # Better for Linux environments
        make \
        vim \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Set work directory
WORKDIR /app

# Install pip and build tools
RUN pip install --upgrade pip \
    && pip install build wheel setuptools

# Copy requirements files
COPY requirements/ /app/requirements/

# Install dependencies directly from .in files (skipping pip-compile)
# This direct installation approach avoids potential pip-compile issues
RUN set -ex \
    && echo "Installing base requirements..." \
    && pip install -r /app/requirements/base.in \
    && echo "Installing production requirements..." \
    && pip install -r /app/requirements/production.in \
    && echo "Installing development requirements..." \
    && pip install -r /app/requirements/development.in

# Create directories
RUN mkdir -p /app/static /app/media /app/logs

# Create a Linux-specific entrypoint script
COPY ./docker/entrypoint.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/entrypoint.sh

# Set Linux permissions
RUN echo '#!/bin/bash\n\
echo "Starting Django development server..."\n\
python manage.py runserver 0.0.0.0:8000\n\
' > /usr/local/bin/start_dev.sh \
    && chmod +x /usr/local/bin/start_dev.sh

# Run entrypoint script
ENTRYPOINT ["entrypoint.sh"]

# Default command
CMD ["python", "manage.py", "runserver", "0.0.0.0:8000"] 