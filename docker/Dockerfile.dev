FROM python:3.13-slim

ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

# Install system dependencies
RUN apt-get update \
    && apt-get install -y --no-install-recommends \
        gcc \
        python3-dev \
        libpq-dev \
        postgresql-client \
        netcat-traditional \
        wget \
        curl \
        # WeasyPrint dependencies
        libcairo2 \
        libpango-1.0-0 \
        libpangocairo-1.0-0 \
        libgdk-pixbuf2.0-0 \
        shared-mime-info \
        # Additional tools
        git \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Set work directory
WORKDIR /app

# Update pip
RUN pip install --upgrade pip

# Copy requirements files
COPY requirements/ /app/requirements/

# Install development dependencies directly
RUN echo "Installing critical packages..." && \
    pip install --no-cache-dir django django-filter djangorestframework celery redis

# Install development-specific packages
RUN echo "Installing development packages..." && \
    pip install --no-cache-dir black flake8 ipython pytest pytest-django pytest-cov

# Install Django packages
RUN pip install --no-cache-dir "django-redis>=5.4.0,<5.5.0"
RUN pip install --no-cache-dir "redis>=5.0.0,<5.1.0"
RUN pip install --no-cache-dir "django-cors-headers>=4.3.1,<4.4.0"
RUN pip install --no-cache-dir "drf-yasg>=1.21.7,<1.22.0"
RUN pip install --no-cache-dir "djangorestframework-simplejwt>=5.3.0,<5.4.0"
RUN pip install --no-cache-dir "mysqlclient>=2.2.0,<2.3.0" "pymysql>=1.1.0,<1.2.0"

# Install Celery and related packages
RUN pip install --no-cache-dir django-celery-results django-celery-beat

# Install logging packages
RUN pip install --no-cache-dir python-json-logger structlog

# Install additional base packages
RUN pip install --no-cache-dir django-environ Pillow WeasyPrint

# Create directories for static and media files
RUN mkdir -p /app/static /app/media /app/logs

# Copy entrypoint script
COPY ./docker/entrypoint.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/entrypoint.sh

# Run entrypoint script
ENTRYPOINT ["entrypoint.sh"]

# Default command
CMD ["python", "manage.py", "runserver", "0.0.0.0:8000"] 