FROM python:3.12-slim

# Install system dependencies
RUN apt-get update \
    && apt-get install -y --no-install-recommends \
        build-essential \
        curl \
        git \
        libpq-dev \
        netcat-traditional \
        supervisor \
        nginx \
        libffi-dev \
        libjpeg-dev \
        libxml2-dev \
        libxslt-dev \
        zlib1g-dev \
        libcairo2-dev \
        libpango1.0-dev \
        libgdk-pixbuf2.0-dev \
        shared-mime-info \
        libssl-dev \
        postgresql-client \
        redis-server \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Install Node.js
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
    && apt-get install -y nodejs \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# Upgrade pip
RUN pip install --upgrade pip

# Copy requirements files
COPY requirements/ /app/requirements/

# Install development dependencies
RUN pip install --no-cache-dir -r /app/requirements/requirements.dev.txt

# Create directories for static, media, logs, and data files
RUN mkdir -p /app/static /app/media /app/logs /app/data \
    && mkdir -p /var/log/supervisor \
    && mkdir -p /var/run \
    && mkdir -p /etc/supervisor/conf.d \
    && chown -R root:root /var/log/supervisor \
    && chown -R root:root /var/run \
    && chmod -R 755 /app/logs

# Expose ports for Django and Redis
EXPOSE 8050 6379 3000

# Set environment variables
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    DJANGO_SETTINGS_MODULE=pyerp.settings.development

# Copy supervisord configuration
COPY docker/supervisord.dev.conf /etc/supervisor/conf.d/supervisord.conf

# Copy static directories setup script
COPY docker/ensure_static_dirs.sh /app/docker/ensure_static_dirs.sh
RUN chmod +x /app/docker/ensure_static_dirs.sh

# Set up entrypoint
COPY docker/entrypoint.dev.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"] 